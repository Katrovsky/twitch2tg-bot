# Twitch Stream Monitor

Инструмент для автоматического мониторинга Twitch-трансляций с уведомлениями в Telegram. Отправляет сообщение при начале стрима, обновляет статистику по ходу эфира и публикует итоги после завершения.

## Что это такое

Приложение запускается на вашем компьютере или сервере, следит за выбранным каналом на Twitch и отправляет уведомления в нужный Telegram-чат или канал. Всё происходит автоматически — после настройки вмешательство не требуется.

**Старт стрима** — бот отправляет сообщение с превью трансляции, названием, категорией и кнопкой для быстрого перехода на канал.

**Во время трансляции** — сообщение периодически обновляется: добавляется время в эфире, число зрителей, среднее значение и динамика аудитории (растёт / стабильно / падает). Если за время стрима появились клипы — они перечислены под статистикой как кликабельные ссылки.

**Конец стрима** — итоговое сообщение со временем в эфире, средним и пиковым числом зрителей, количеством клипов и ссылками на них.

Приложение работает локально. Никаких внешних сервисов для его работы не нужно — только доступ в интернет.

## Как это работает

Приложение с заданным интервалом обращается к официальному API Twitch и проверяет статус канала. По умолчанию — раз в 60 секунд. Когда канал выходит в эфир, бот отправляет сообщение через Telegram Bot API.

Во время трансляции приложение фиксирует число зрителей при каждой проверке. Из этих данных рассчитываются средние показатели и определяется тренд аудитории. Сообщение обновляется с отдельным интервалом — по умолчанию раз в 5 минут.

Если связь временно пропадает, приложение автоматически повторяет попытки с нарастающей паузой между ними и восстанавливает работу без потери данных.

## Системные требования

- **ОС:** Windows, Linux, macOS
- **Архитектура:** x86_64 (большинство ПК и ноутбуков), ARM (Raspberry Pi и аналоги)
- **Место на диске:** 50 МБ
- **Оперативная память:** 20 МБ
- **Интернет:** стабильный доступ к `api.twitch.tv` и `api.telegram.org`

## Установка

1. Перейдите на страницу релизов проекта на GitHub.
2. Скачайте архив для вашей системы:
   - Windows: `windows_x86_64`
   - Mac с процессором Apple Silicon (M1/M2/M3): `darwin_arm64`
   - Mac с процессором Intel: `darwin_x86_64`
   - Linux: `linux_x86_64` или `linux_arm64`
3. Распакуйте архив в любую удобную папку.
4. На Linux и macOS выполните в терминале:

   ```
   chmod +x twitch-monitor
   ```

Установка дополнительных программ не требуется — всё включено в один файл.

## Настройка Twitch API

Для работы с Twitch необходимо зарегистрировать приложение в консоли разработчика.

1. Откройте [dev.twitch.tv/console](https://dev.twitch.tv/console) и войдите в свой аккаунт Twitch.
2. Нажмите **Register Your Application**.
3. Заполните поля:
   - **Name** — любое название, например `Stream Monitor`
   - **OAuth Redirect URLs** — `http://localhost`
   - **Category** — `Application Integration`
4. Нажмите **Create**.
5. В списке приложений нажмите **Manage** рядом со своим.
6. Скопируйте **Client ID**.
7. Нажмите **New Secret**, скопируйте и сохраните **Client Secret** — он отображается только один раз.

## Создание Telegram-бота

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/BotFather).
2. Отправьте команду `/newbot`.
3. Введите **название** бота (отображается в чате), например `My Stream Monitor`.
4. Введите **имя пользователя** (должно заканчиваться на `bot`), например `my_stream_monitor_bot`.
5. BotFather пришлёт **токен** — строку вида `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`. Сохраните его.

## Первоначальная настройка

При первом запуске приложение автоматически проведёт через все шаги настройки.

**Запуск:**

- Windows: двойной клик по файлу приложения
- Linux / macOS: в терминале выполните `./twitch-monitor`

**Шаги настройки:**

**1. Twitch API** — введите Client ID и Client Secret. Приложение проверит, что данные верны.

**2. Канал** — введите точное имя пользователя канала на Twitch (только логин, без ссылки). Например: `examplestreamer`. Приложение проверит, что канал существует.

**3. Telegram-бот** — введите токен, полученный от BotFather.

**4. Чат для уведомлений** — выберите способ:

- **Автоматический** (для групп): добавьте бота в группу как администратора и отправьте в группу команду `SETUP`. Приложение определит ID чата само.
- **Ручной** (для каналов): добавьте бота в канал как администратора с правом публикации. Перешлите любое сообщение из канала боту [@userinfobot](https://t.me/userinfobot) — он вернёт ID чата в формате `-1001234567890`. Введите это число в приложение.

После указания чата приложение проверит права бота. Если прав недостаточно — выведет подсказку и подождёт, пока вы их предоставите.

**5. Язык уведомлений** — `ru` или `en`. Влияет на текст в Telegram-сообщениях.

**6. Интервалы:**

- **Интервал проверки** — как часто приложение проверяет статус канала (в секундах). По умолчанию: `60`. Минимум рекомендуется не менее `30`.
- **Интервал обновления** — как часто обновляется сообщение во время стрима (в минутах). По умолчанию: `5`.

После завершения настройки создаётся файл `config.json`, и мониторинг запускается автоматически.

## Формат уведомлений

**Начало стрима:**

```
examplestreamer • LIVE • Just Chatting

Название сегодняшнего стрима

#тег1 #тег2
```

**Во время стрима:**

```
examplestreamer • LIVE • Just Chatting

Название сегодняшнего стрима

2 ч 10 мин · 4.2K зрителей, 3.8K среднее · растёт

Смешной момент · Лучший клип дня

#тег1 #тег2
```

**Конец стрима:**

```
examplestreamer • OFFLINE • Just Chatting

Название сегодняшнего стрима

3 ч 45 мин · 3.8K среднее, 6.1K пик · 5 клипов

Смешной момент · Лучший клип дня · Ещё один клип

#тег1 #тег2
```

К каждому сообщению прикреплено превью трансляции и кнопка перехода на канал. Превью обновляется вместе с текстом.

## Работа в фоновом режиме

**Windows** — поместите ярлык приложения в папку автозагрузки. Откройте её через `Win + R` → `shell:startup`. Для запуска в свёрнутом виде создайте `.bat`-файл с командой:

```bat
start /min "" twitch-monitor.exe
```

и разместите его в папке автозагрузки.

**Linux (systemd)** — создайте файл `/etc/systemd/system/twitch-monitor.service`:

```ini
[Unit]
Description=Twitch Stream Monitor
After=network.target

[Service]
ExecStart=/opt/twitch-monitor/twitch-monitor
WorkingDirectory=/opt/twitch-monitor
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Затем выполните:

```
sudo systemctl enable twitch-monitor
sudo systemctl start twitch-monitor
```

**macOS (LaunchAgents)** — создайте файл `~/Library/LaunchAgents/com.twitch-monitor.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.twitch-monitor</string>
  <key>ProgramArguments</key>
  <array>
    <string>/Users/username/twitch-monitor/twitch-monitor</string>
  </array>
  <key>WorkingDirectory</key>
  <string>/Users/username/twitch-monitor</string>
  <key>RunAtLoad</key>
  <true/>
  <key>KeepAlive</key>
  <true/>
</dict>
</plist>
```

Затем выполните:

```
launchctl load ~/Library/LaunchAgents/com.twitch-monitor.plist
```

## Изменение настроек

Все параметры хранятся в файле `config.json` рядом с приложением. Его можно открыть в любом текстовом редакторе.

Для повторного прохождения настройки запустите приложение с флагом:

```
./twitch-monitor --setup
```

Уже заполненные параметры при этом не затрагиваются.

**Основные параметры:**

| Параметр | Описание |
|---|---|
| `channel` | Имя пользователя канала на Twitch |
| `client_id` | Client ID из консоли Twitch |
| `client_secret` | Client Secret из консоли Twitch |
| `bot_token` | Токен Telegram-бота |
| `chat_id` | ID чата или канала для уведомлений |
| `thread_id` | ID топика (только для групп с топиками) |
| `language` | Язык уведомлений: `ru` или `en` |
| `check_interval_seconds` | Интервал проверки статуса канала (сек.) |
| `update_interval_minutes` | Интервал обновления сообщения (мин.) |

После изменения `config.json` перезапустите приложение.

Вместо хранения секретных данных в файле можно использовать переменные окружения — они имеют приоритет над `config.json`:

```
TWITCH_CLIENT_ID=ваш_client_id
TWITCH_CLIENT_SECRET=ваш_client_secret
TELEGRAM_BOT_TOKEN=ваш_токен
```

## Мониторинг нескольких каналов

Создайте отдельную копию приложения в отдельной папке для каждого канала. Каждая копия работает независимо со своим `config.json`. Можно использовать одного Telegram-бота с разными чатами или создать отдельного бота для каждого канала.

## Решение проблем

**Приложение не запускается** — на Linux и macOS убедитесь, что файл имеет право на выполнение (`chmod +x twitch-monitor`). Проверьте, не блокирует ли файл антивирус или брандмауэр.

**Уведомления не приходят** — проверьте, что бот добавлен в чат как администратор с правом публикации сообщений. Убедитесь, что `chat_id` указан верно. Для каналов ID должен начинаться с `-100`.

**Ошибки подключения к API** — проверьте интернет-соединение и убедитесь, что брандмауэр или прокси не блокируют доступ к `api.twitch.tv` и `api.telegram.org`. Если используется корпоративная сеть с SSL-инспекцией — отключите её для этих доменов.

**Диагностика** — запустите приложение из терминала или командной строки. Все события и ошибки выводятся в консоль. Для сохранения логов в файл:

```
./twitch-monitor >> monitor.log 2>&1
```

## Обновление

1. Остановите приложение.
2. Скачайте новую версию со страницы релизов.
3. Замените исполняемый файл, не трогая `config.json`.
4. Запустите приложение — настройки применятся автоматически.

Перед обновлением рекомендуется сохранить копию `config.json`.
